<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recorder</title>
    <style>
        #conversation {
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 600px;
            height: 400px;
            overflow-y: scroll;
            margin-top: 20px;
        }
        .message {
            margin-bottom: 10px;
        }
        .user {
            color: blue;
        }
        .chatbot {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Voice Recorder</h1>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <div id="conversation"></div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let stream;
        let isMicInitialized = false;
        let websocket;

        document.getElementById('startBtn').addEventListener('click', async () => {
            if (!isMicInitialized) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isMicInitialized = true;
                } catch (error) {
                    console.error('마이크 권한을 요청하는 중 에러 발생:', error);
                    return;
                }
            }

            // 웹소켓 연결을 시작 버튼을 누른 후에 설정
            if (!websocket || websocket.readyState === WebSocket.CLOSED) {
                // websocket = new WebSocket('ws://localhost:8000/ws/chatbot');
                websocket = new WebSocket('wss://robin-alert-lioness.ngrok-free.app/ws/chatbot');
                websocket.onmessage = function (event) {
                    // 챗봇 응답을 conversation 영역에 추가
                    appendMessage('Chatbot', event.data);
                };
            }

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.wav');

                // 음성 파일을 서버에 전송하고 transcription을 즉시 받음
                const response = await fetch('https://robin-alert-lioness.ngrok-free.app/audio', {
                // const response = await fetch('http://localhost:8000/audio', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                appendMessage('User', result.transcription);

                // WebSocket을 통해 transcription을 챗봇 서버에 전송
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send(result.transcription);
                } else {
                    console.error('WebSocket 연결이 열려 있지 않습니다.');
                }
            };

            mediaRecorder.start();
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('startBtn').disabled = true;
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            mediaRecorder.stop();
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
            audioChunks = []; // Reset audio chunks for next recording
        });

        function appendMessage(sender, message) {
            const conversationDiv = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender.toLowerCase());
            messageDiv.textContent = `${sender}: ${message}`;
            conversationDiv.appendChild(messageDiv);
            conversationDiv.scrollTop = conversationDiv.scrollHeight; // 대화 영역을 아래로 스크롤
        }

    </script>
</body>
</html>
